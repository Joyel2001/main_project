{% extends 'main/ecomerce/baseeco.html' %}

{% block content %}
<br><br><br><br>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shopping Cart</title>
    <!-- Bootstrap CSS -->
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" rel="stylesheet">
    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <!-- Bootstrap JS -->
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"></script>
    <!-- Custom CSS -->
    <style>
        /* Add your custom styles here */
        body {
            padding-top: 20px;
        }
        .cart-item {
            border-bottom: 1px solid #dee2e6;
            padding: 15px 0;
        }
        .cart-item img {
            max-width: 100px;
            height: auto;
        }
    </style>
</head>
<body>
<div class="container">
    <h1 class="mb-4">Shopping Cart</h1>
    <div class="row">
        <div class="col-md-8">
            <!-- Cart Items -->
            {% if cart_items %}
            {% for item in cart_items %}
            <div class="cart-item row">
                <div class="col-md-3">
                    <img src="{{ item.product.product_image.url }}" alt="{{ item.product.name }}" class="img-fluid">                </div>
                <div class="col-md-5">
                    <h4>{{ item.product.name }}</h4>
                    <p>{{ item.product.description }}</p>
                </div>
                <div class="col-md-2">
                    <p>Quantity: <span id="quantity_{{ item.id }}">{{ item.quantity }}</span></p>
                    <button class="btn btn-sm btn-primary" onclick="updateQuantity('{{ item.id }}', 'add')">+</button>
                    <button class="btn btn-sm btn-danger" onclick="updateQuantity('{{ item.id }}', 'remove')">-</button>

                </div>
                <div class="col-md-2">
                    <p>Price: Rs {{ item.product.selling_price }}</p>
                </div>
                <div class="col-md-2">
                    <p><button class="btn btn-sm btn-danger" onclick="deleteItem('{{ item.id }}')">Delete</button></p>
                </div>
            </div>
            {% endfor %}
            {% else %}
            <p>Your cart is empty.</p>
            {% endif %}
        </div>
        <div class="col-md-4">
            <!-- Cart Summary -->
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Cart Summary</h5>
                    <p class="card-text">Total Items: <span id="total_items">{{ total_items }}</span></p>
                    <p class="card-text">Total Price: <span id="total_price">Rs {{ total_price }}</span></p>
                    {% if total_price > 0 %}
                        <a href="{% url 'paymentform1' %}?amount={{ total_price }}" class="btn btn-primary">Checkout</a>
                    {% else %}
                        <p class="text-danger">Payment cannot be performed as the total price is zero.</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
<!-- Bootstrap modal for confirmation -->
<div class="modal fade" id="confirmDeleteModal" tabindex="-1" role="dialog" aria-labelledby="confirmDeleteModalLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="confirmDeleteModalLabel">Confirmation</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        Are you sure you want to delete this item from the cart?
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-danger" id="confirmDeleteBtn">Delete</button>
      </div>
    </div>
  </div>
</div>
<script>
    $(document).ready(function() {
        // Hide or show the checkout button based on the total price
        var totalPrice = parseFloat('{{ total_price }}');
        if (totalPrice > 0) {
            $('#checkoutBtn').show();
        } else {
            $('#checkoutBtn').hide();
        }
    });

    function updateQuantity(itemId, action) {
        // Retrieve the current quantity and maximum stock from the page
        var currentQuantity = parseInt($('#quantity_' + itemId).text());
        var maxStock = parseInt('{{ item.product.quantity }}'); // Assuming quantity is a field in your Product model

        // If action is 'add', check if adding 1 exceeds the maximum stock, if so, show alert
        if (action === 'add' && currentQuantity >= maxStock) {
            alert("Sorry, the maximum available quantity is " + maxStock);
            return;
        }

        // If action is 'add', check if adding 1 exceeds the maximum stock, if so, set quantity to maxStock
        if (action === 'add' && currentQuantity < maxStock) {
            currentQuantity += 1;
        }

        // Send AJAX request to update quantity
        $.ajax({
            url: '/update_quantity/',
            method: 'POST',
            data: {
                'item_id': itemId,
                'action': action,
                'csrfmiddlewaretoken': '{{ csrf_token }}'
            },
            success: function(response) {
                // Update quantity and total price on the page
                $('#quantity_' + itemId).text(response.quantity);
                $('#total_items').text(response.total_items);
                $('#total_price').text('Rs ' + response.total_price.toFixed(2));
                // Check if total price is greater than zero to show checkout button
                if (response.total_price > 0) {
                    $('#checkoutBtn').show();
                } else {
                    $('#checkoutBtn').hide();
                }
            },
            error: function(xhr, status, error) {
                console.error(xhr.responseText);
            }
        });
    }

    function deleteItem(itemId) {
        // Show confirmation modal
        $('#confirmDeleteModal').modal('show');

        // Set click event for delete button in the modal
        $('#confirmDeleteBtn').click(function() {
            // Send AJAX request to delete item
            $.ajax({
                url: '/delete_item/',
                method: 'POST',
                data: {
                    'item_id': itemId,
                    'csrfmiddlewaretoken': '{{ csrf_token }}'
                },
                success: function(response) {
                    // Reload the page after successful deletion
                    location.reload();
                },
                error: function(xhr, status, error) {
                    console.error(xhr.responseText);
                }
            });

            // Hide the modal
            $('#confirmDeleteModal').modal('hide');
        });
    }
</script>

      
   

</body>
</html>
{% endblock content %}
